<style>
    .mngCar{margin:100px 20px;width:auto;}
    .mngCar-nav ul li .icon1{background-image:url('img/mng/car/carBase.png');}
    .mngCar-nav ul li .icon2{background-image:url('img/mng/car/transport.png');}
    .mngCar-nav ul li .icon3{background-image:url('img/mng/car/policy.png');}
    .mngCar-nav ul li .icon4{background-image:url('img/mng/car/other.png');}
</style>
    
<div class="mngCar">
    <div class="mngCar-btn zoom">
        <button class="moperation-btn moperation-add icon-add" id="add">添加</button>
        <button class="moperation-btn moperation-remove icon-remove" id="remove">删除</button>
        <div class="mngCar-btn-right"><button class="moperation-btn" id="remind">到期明细</button><span id="count">12</span></div>
    </div>
    <div class="mngCar-nav">
        <ul class="zoom">
            <li class="online"><span class="icon1" d-type="driver">行驶证管理</span></li>
            <li class="default"><span class="icon2" d-type="transport">运输证管理</span></li>
            <li class="default"><span class="icon3" d-type="policy">保单</span></li>
            <li class="default"><span class="icon4" d-type="other">车辆其他</span></li>
        </ul>
    </div>

    <table class="ttable" id="ttable"></table>
    <div id="pageDemo"></div>
</div>

<script type="text/javascript">
    var info_mngCarCertificates = {
        type:"driver"
    };

    //fn_breadcrumbs
    fn_breadcrumbs([
        {name:"系统中心"},
        {name:"车辆管理",href:"mng-nav"},
        {name:"证件管理"},
    ]);

    var tt = {
        elem:$("#ttable"),
        titles:['checkbox','序号','车牌号','所属公司','所属车队','行驶证号','办证时间','证件开始时间','证件结束时间','备注信息','操作'],
        items:"请选择条件查询",
    };
    var ttable = new fn_ttable(tt);

    function ajax_get_license_info_list(set){
        $.ajax({
            url:ajax_106+"/get_license_info_list",
            type:"post",
            dataType:"json",
            data:set
        }).then(function(data){
            if(data.code === "0000"){
                data = data.data;
                if(pageSign===1){
                    pageSign++;
                    new fn_page({elem:"pageDemo",pages:data.total,fn:ajax_get_license_info_list,set:set});//初始化分页
                }

                if(set.license_type == "1"){
                    fn_list_1(data.items,"mng_car_certificates");
                }else if(set.license_type == "2"){
                    fn_list_2(data.items,"mng_car_certificates");
                }else if(set.license_type == "3"){
                    fn_list_3(data.items,"mng_car_certificates");
                }else if(set.license_type == "4"){
                    fn_list_4(data.items,"mng_car_certificates");
                }

            }
        });
    }

    function fn_list_1(items,sign){
        if(items === "loading"){
            ttable.init({items:"加载中……"});
            return;
        }

        if(!items || items.length==0){
            ttable.init({items:[]});
            return;
        }

        if(sign != "mng_car_certificates")return;

        data_rank = items;

        var items = fn_format_arr(items);

        var arr = [];
        items.forEach(function(el,index){
            index++;
            var hover_data = {
                id:el.id,
                type:info_mngCarCertificates.type
            };
            var html_operation = '<a class="hover" d-data=\''+JSON.stringify(hover_data)+'\'>编辑</a>';
            var obj = {tds:[
                '<div class="dcheckbox"><input type="checkbox" id='+el.id+'><label for="'+el.id+'" class="default"></label></div>',
                index,
                el.license_plate,
                el.enterprise_name,
                el.team_name,
                el.license_id,
                el.time_of_certification,
                //el.vehicle_brand,
                //el.engine_number,
                el.start_effective_date,
                el.end_effective_date,
                el.information,
                html_operation,
            ]};
            arr.push(obj);
        });
        ttable.init({items:arr});
    }

    function fn_list_2(items,sign){
        if(items === "loading"){
            ttable.init({items:"加载中……"});
            return;
        }

        if(!items || items.length==0){
            ttable.init({items:[]});
            return;
        }

        if(sign != "mng_car_certificates")return;

        data_rank = items;

        var items = fn_format_arr(items);

        var arr = [];
        items.forEach(function(el,index){
            index++;
            var hover_data = {
                id:el.id,
                type:info_mngCarCertificates.type
            };
            var html_operation = '<a class="hover" d-data=\''+JSON.stringify(hover_data)+'\'>编辑</a>';
            var obj = {tds:[
                '<div class="dcheckbox"><input type="checkbox" id='+el.id+'><label for="'+el.id+'" class="default"></label></div>',
                index,
                el.license_plate,
                el.enterprise_name,
                el.team_name,
                el.license_id,
                //el.vehicle_brand,
                //el.engine_number,
                el.start_effective_date,
                el.end_effective_date,
                el.information,
                html_operation,
            ]};
            arr.push(obj);
        });
        ttable.init({items:arr});
    }

    function fn_list_3(items,sign){
        if(items === "loading"){
            ttable.init({items:"加载中……"});
            return;
        }

        if(!items || items.length==0){
            ttable.init({items:[]});
            return;
        }

        if(sign != "mng_car_certificates")return;

        data_rank = items;

        var items = fn_format_arr(items);

        var arr = [];
        items.forEach(function(el,index){
            index++;
            var hover_data = {
                id:el.id,
                type:info_mngCarCertificates.type
            };
            var html_operation = '<a class="hover" d-data=\''+JSON.stringify(hover_data)+'\'>编辑</a>';
            var obj = {tds:[
                '<div class="dcheckbox"><input type="checkbox" id='+el.id+'><label for="'+el.id+'" class="default"></label></div>',
                index,
                el.license_plate,
                el.enterprise_name,
                el.team_name,
                el.license_id,
                //l.vehicle_brand,
                //el.engine_number,
                el.start_effective_date,
                el.end_effective_date,
                el.information,
                html_operation,
            ]};
            arr.push(obj);
        });
        ttable.init({items:arr});
    }

    function fn_list_4(items,sign){
        if(items === "loading"){
            ttable.init({items:"加载中……"});
            return;
        }

        if(!items || items.length==0){
            ttable.init({items:[]});
            return;
        }

        if(sign != "mng_car_certificates")return;

        data_rank = items;

        var items = fn_format_arr(items);

        var arr = [];
        items.forEach(function(el,index){
            index++;
            var hover_data = {
                id:el.id,
                type:info_mngCarCertificates.type
            };
            var html_operation = '<a class="hover" d-data=\''+JSON.stringify(hover_data)+'\'>编辑</a>';
            var obj = {tds:[
                '<div class="dcheckbox"><input type="checkbox" id='+el.id+'><label for="'+el.id+'" class="default"></label></div>',
                index,
                el.license_plate,
                el.enterprise_name,
                el.team_name,
                el.license_id,
                //el.vehicle_brand,
                //el.engine_number,
                el.start_effective_date,
                el.end_effective_date,
                el.information,
                html_operation,
            ]};
            arr.push(obj);
        });
        ttable.init({items:arr});
    }

    var pageSign = 1;//分页需要的参数
    var curr = 1;//分页当前页
    var data_set = {
        extra_id:info_login.data.extraid,
        license_type:1,
        page:1,
        interval:10,
    };
    ajax_get_license_info_list(data_set);

    function ajax_delete_license_info(id){
        $.ajax({
            url:ajax_106+"/delete_license_info",
            type:"post",
            dataType:"json",
            data:{license_ids:id}
        }).then(function(data){
            if(data.code === "0000"){
                toastr.success(data.message);
                pageSign = 1;//分页需要的参数
                curr = 1;//分页当前页
                data_set.page = 1;
                ajax_get_license_info_list(data_set);
                ajax_get_out_of_time_license_num();//获取到期数量
            }
        });
    }

    //获取到期数量
    function ajax_get_out_of_time_license_num(){
        $.ajax({
            url:ajax_106+"/get_out_of_time_license_num",
            type:"post",
            dataType:"json",
            data:{extra_id:info_login.data.extraid}
        }).then(function(data){
            if(data.code === "0000"){
                var count = parseInt(data.data[0].count);
                console.log(count)
                if(count > 0){
                    $("#count").show();
                    $("#count").html(count);
                }else{
                    $("#count").hide();
                    $("#count").html(0);
                }
            }
        });
    }
    ajax_get_out_of_time_license_num();

    $(function(){
        $(document).off("click",".mngCar-nav li").on("click",".mngCar-nav li",function(){
            $(".mngCar-nav li").attr("class","default");
            $(this).attr("class","online");

            var str = $(this).find("span").attr("d-type");
            info_mngCarCertificates = {
                type:str
            };
            window.sessionStorage.info_mngCarCertificates = JSON.stringify(info_mngCarCertificates);

            var sign = $(this).find("span").html();
            if(sign === "行驶证管理"){
                tt = {
                    elem:$("#ttable"),
                    titles:['checkbox','序号','车牌号','所属公司','所属车队','行驶证号','办证时间','证件开始时间','证件结束时间','备注信息','操作'],
                    items:"请选择条件查询",
                };
                pageSign = 1;//分页需要的参数
                curr = 1;//分页当前页
                data_set = {
                    extra_id:info_login.data.extraid,
                    license_type:1,
                    page:1,
                    interval:10,
                };
                ajax_get_license_info_list(data_set);
            }else if(sign === "运输证管理"){
                tt = {
                    elem:$("#ttable"),
                    titles:['checkbox','序号','车牌号码','所属公司','所属车队','运输证号','证件开始时间','证件结束时间','备注信息','操作'],
                    items:"请选择条件查询",
                };
                pageSign = 1;//分页需要的参数
                curr = 1;//分页当前页
                data_set = {
                    extra_id:info_login.data.extraid,
                    license_type:2,
                    page:1,
                    interval:10,
                };
                ajax_get_license_info_list(data_set);
            }else if(sign === "保单"){
                tt = {
                    elem:$("#ttable"),
                    titles:['checkbox','序号','车牌号码','所属公司','所属车队','保单号','证件开始时间','证件结束时间','备注信息','操作'],
                    items:"请选择条件查询",
                };
                pageSign = 1;//分页需要的参数
                curr = 1;//分页当前页
                data_set = {
                    extra_id:info_login.data.extraid,
                    license_type:3,
                    page:1,
                    interval:10,
                };
                ajax_get_license_info_list(data_set);
            }else if(sign === "车辆其他"){
                tt = {
                    elem:$("#ttable"),
                    titles:['checkbox','序号','车牌号码','所属公司','所属车队','其他证件号','证件开始时间','证件结束时间','备注信息','操作'],
                    items:"请选择条件查询",
                };
                pageSign = 1;//分页需要的参数
                curr = 1;//分页当前页
                data_set = {
                    extra_id:info_login.data.extraid,
                    license_type:4,
                    page:1,
                    interval:10,
                };
                ajax_get_license_info_list(data_set);
            }
            ttable = new fn_ttable(tt);
        });

        //跳转页面
        $(document).off("click","#add").on("click","#add",function(){
            var str = $(".mngCar-nav .online span").attr("d-type");
            info_mngCarCertificates = {
                type:str
            };
            window.sessionStorage.info_mngCarCertificates = JSON.stringify(info_mngCarCertificates);
            console.log(JSON.stringify(info_mngCarCertificates));
            ajax_nav("mng-car-certificates-add");
        });

        //跳转页面
        $(document).off("click","#remind").on("click","#remind",function(){
            ajax_nav("mng-car-certificates-remind");
        });

        $(document).off("click","#remove").on("click","#remove",function(){
            var arr = ttable.checked();
            if(arr.length == 0){
                toastr.error("请选择需要删除的项");
                return;
            }
            arr = JSON.stringify(arr);
            ajax_delete_license_info(arr);
            console.log(arr)
        });


        $(document).off("click",".hover").on("click",".hover",function(){
            window.sessionStorage.info_mngCarCertificates = $(this).attr("d-data");
            ajax_nav("mng-car-certificates-edit");
        });
    });
</script>



