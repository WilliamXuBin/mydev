<style>
	.infoBlock{padding:5px 15px;background:#fff;border-radius:3px;font-size:12px;}
	.infoBlock:before{
	    box-sizing: content-box;
	    width: 0px;
	    height: 0px;
	    position: absolute;
	    bottom: -16px;
	    left:50%;
	    margin-left:-4px;
	    padding:0;
	    border-bottom:8px solid transparent;
	    border-top:8px solid #FFFFFF;
	    border-left:8px solid transparent;
	    border-right:8px solid transparent;
	    display: block;
	    content:'';
	    z-index: 12;
	}
	.infoBlock:after{
	    box-sizing: content-box;
	    width: 0px;
	    height: 0px;
	    position: absolute;
	    bottom: -18px;
	    left:50%;
	    margin-left:-4.5px;
	    padding:0;
	    border-bottom:9px solid transparent;
	    border-top:9px solid #cccccc;
	    border-left:9px solid transparent;
	    border-right:9px solid transparent;
	    display: block;
	    content:'';
	    z-index:10
	}
	.infoBlock-default{width:300px;margin:5px 0 10px 0;}
	.infoBlock-default-title{height:30px;line-height:30px;color:#38579d;margin-bottom:5px;font-size:12px;}
	.infoBlock-default-txt{margin-bottom:22px;font-size:12px;}
	.infoBlock-default-btn{}
	.infoBlock-default-btn button{width:140px;}
	.infoBlock-default-btn button:last-child{float:right;}

	.infoBlock-edit{width:400px;}
	.infoBlock-edit-title{border-bottom:1px solid #dee0e3;padding: 7px 0 10px 0;}
	.infoBlock-edit-title span{display:block;}
	.infoBlock-edit-t1{color:#38579d;padding-right:10px;line-height:20px;}
	.infoBlock-edit-t2{line-height:20px;}
	.infoBlock-edit-item{margin:10px 0;}
	.infoBlock-edit-tle{width:85px;float:left;height:38px;line-height:38px;}
	.infoBlock-edit-cnt{width:calc(100% - 85px);float:left;}
	.infoBlock-edit-text{width:100%;height:38px;border:1px solid #dee0e3;border-radius:3px;padding:0 10px;}
	.infoBlock-edit-defaultRadio{margin-bottom:10px;}
	.infoBlock-edit-defaultRadio span{display:inline-block;height:30px;line-height:30px;border:1px solid #dee0e3;padding:0 10px;font-size:12px;border-radius:3px;margin-right:10px;cursor:pointer;}
	.infoBlock-edit-defaultRadio .active{border-color:red;}
	.infoBlock-edit-box{}
	.infoBlock-edit-box input{width:200px;display:block;float:left;}
	.infoBlock-edit-box span{display:block;float:left;margin-left:10px;margin-top:25px;}
	.infoBlock-edit-button{margin:30px 0 0px 0;text-align:right;}
	.infoBlock-edit-button button{width:50px;margin-left:5px;}

	.ctrlBlock{width:auto;}
	#fenceBlock{margin-bottom:15px;}
	#fenceBlock ul{min-width:240px;float:left;}
	#fenceBlock ul li{display:inline-block;height:28px;line-height:28px;}
	#fenceBlock ul li span{display:block;background-repeat:no-repeat;background-position:left center;margin-right:15px;cursor:pointer;}
	.fenceBlock-type1 .default{background-image:url("img/fence/type/point_default.png");padding-left:23px;background-size:16px;color:#fff;}
	.fenceBlock-type1 .active{background-image:url("img/fence/type/point_pressed.png");padding-left:23px;background-size:16px;color:#fdca00;}
	.fenceBlock-type2 .default{background-image:url("img/fence/type/region_default.png");padding-left:28px;background-size:19px;color:#fff;}
	.fenceBlock-type2 .active{background-image:url("img/fence/type/region_pressed.png");padding-left:28px;background-size:19px;color:#fdca00;}
	.fenceBlock-type3 .default{background-image:url("img/fence/type/province_default.png");padding-left:33px;background-size:23px;color:#fff;}
	.fenceBlock-type3 .active{background-image:url("img/fence/type/province_pressed.png");padding-left:33px;background-size:23px;color:#fdca00;}
	.fenceBlock-remove{width:30px;height:28px;line-height:28px;font-size:28px;text-align:center;float:right;color:#fff;cursor:pointer;}

	.fence-city{width:150px;position:relative;}
	.fence-city-title{width:100%;height:30px;line-height:30px;background:#4a516a;color:#fff;text-align:center;position:relative;border-radius:3px;padding-right:20px;}
	.fence-city-title:before{
		box-sizing: content-box;
	    width: 0px;
	    height: 0px;
	    position: absolute;
	    top: 11px;
	    right:8px;
	    padding:0;
	    border-bottom:6px solid transparent;
	    border-top:6px solid #FFFFFF;
	    border-left:6px solid transparent;
	    border-right:6px solid transparent;
	    display: block;
	    content:'';
	    z-index: 12;
	}
	.fence-city select{width:100%;height:30px;position:absolute;top:0px;left:0px;opacity:0;}
	.fence-search{width:100%;margin-bottom:10px;}
	.fence-search input{width:100%;height:45px;background:#4a516a;border:none;border-radius:3px;padding:0 12px;color:#fff;}
	.fence-search ::-webkit-input-placeholder{color:#fff;}
	.fence-search ::-moz-placeholder{color:#fff;}
	.fence-search :-moz-placeholder{color:#fff;}
	.fenceMore{margin-top:10px;color:#fff;display:inline-block;background-image:url('img/icon/arrow_right_white.png');background-repeat:no-repeat;background-position:right 10px center;padding-right:30px;width:160px;text-align:left;cursor:pointer;}

	.regionLocal-tab{width:162px;border:1px solid #4a516a;border-radius:3px;}
	.regionLocal-tab span{display:block;float:left;width:80px;height:30px;line-height:30px;text-align:center;color:#fff;}
	.regionLocal-tab .active{background:#4a516a;}
	.regionLocal-choicePoint{width:100%;margin:30px 0;}
	.regionLocal-choicePoint-round{width:60px;height:60px;line-height:60px;text-align:center;font-size:12px;background:#fdca00;border-radius:50%;box-shadow:0 0 20px rgba(253,200,0,0.4);cursor:pointer;margin:0 auto;}
	.regionLocal-choicePoint-txt{text-align:center;color:#4a516a;font-size:12px;margin:10px 0;}
	.regionLocal-btn button{width:150px;display:block;float:left;}
	.regionLocal-btn button:last-child{float:right;}

	.regionLocal-handPoint{margin:30px 0;}
	.regionLocal-handPoint-title{width:70px;float:left;color:#fff;}
	.regionLocal-handPoint-content{width:calc(100% - 80px);float:right;}
	.regionLocal-handPoint-txt,.regionLocal-handPoint-input{float:left;color:#fff;}
	.regionLocal-handPoint-txt{margin-right:20px;width:30px;}
	.regionLocal-handPoint-input{width: calc(100% - 60px);}
	.regionLocal-handPoint-input input{width:100%;height:24px;border:1px solid #4a516a;border-radius:3px;background:none;color:#fff;padding:0 5px;}
	.regionLocal-handPoint-box{margin-bottom:10px;}
	.regionLocal-addBtn{margin:15px 0;text-align:center;}
	.regionLocal-addBtn span{display:inline-block;width:36px;height:37px;background:url('img/fence/add.png') no-repeat;cursor:pointer;}

	.fenceName-title{border-bottom:1px dashed #4a516a;padding-bottom:10px;margin-bottom:10px;}
	.fenceName-title-txt{height:28px;line-height:28px;color:#fff;float:left;}
	.fenceName-title-close{height:28px;line-height:28px;color:#fff;float:right;font-size:28px;}
	.fenceName-item{margin-bottom:10px;}
	.fenceName-item-title{color:#fff;margin-bottom:8px;font-size:14px;}
	.fenceName-item-content{}
	.fenceName-item-text{width:100%;height:30px;background:#4a516a;padding:0 12px;border-radius:3px;border:none;color:#fff;}
	.fenceName-item-textarea{width:100%;height:100px;background:#4a516a;padding:8px 12px;border-radius:3px;border:none;color:#fff;}
	.fenceName-btn{margin-top:30px;}
	.fenceName-btn button{width:150px;display:block;float:left;}
	.fenceName-btn button:last-child{float:right;margin-left:10px;}

	.simpleMarker{}
	.simpleMarker-title{display:inline-block;padding:0 5px;color:#333;line-height:16px;}
	.simpleMarker-close{display:inline-block;line-height:16px;text-align:center;cursor:pointer;padding:0 5px;font-size:16px;color:#333;}

	.simpleMarker{}
	.simpleMarker-title{display:inline-block;padding:0 5px;color:#333;line-height:16px;}
	.simpleMarker-close{display:inline-block;line-height:16px;text-align:center;cursor:pointer;padding:0 5px;font-size:16px;color:#333;}

	/**加载**/
	.loading_track{width:100%;height:100%;position:fixed;top:0px;left:0px;z-index:9;background:#eee}

	.ctrlBlock-distance{margin-bottom:10px;display:none;}
	.ctrlBlock-distance-top{}
	.ctrlBlock-distance-title{float:left;color:#fff;}
	.ctrlBlock-distance-more{float:right;color:#fdca00;cursor:pointer;}
	.ctrlBlock-distance-main{text-align: center;margin:20px 0 10px 0;}
	.ctrlBlock-distance-main span{
		font-weight:bold;
		display: inline-block;
	    font-size: 30px;
	    font-family: '微软雅黑';
	    background-image: -webkit-gradient(linear, 0 0, 0 bottom, from(#fdca00), to(#4cc9ea));
	    background-image: -moz-gradient(linear, 0 0, 0 bottom, from(#fdca00), to(#4cc9ea));
	    background-image: -o-gradient(linear, 0 0, 0 bottom, from(#fdca00), to(#4cc9ea));
	    -webkit-background-clip: text;
	    -moz-background-clip: text;
	    -o-background-clip: text;
	    -webkit-text-fill-color: transparent;
	    -moz-text-fill-color: transparent;
	    -o-text-fill-color: transparent;
	    color:#fdca00;
	    text-align:center;
	}
	.ctrlBlock-main{background-color:rgba(21,21,30,0.88);box-shadow:0px 3px 6.58px 0.42px rgba(0,0,0,0.8);border-radius:3px;padding:15px 12px;}
	.ctrlBlock-title{color:#fff;border-bottom:1px dashed #4a516a;padding-bottom:12px;margin-bottom:10px;}
	.ctrlBlock-item{margin-bottom:5px;}
	.ctrlBlock-item-title{color:#fff;margin-bottom:10px;}
	.ctrlBlock-item-content{height:40px;position:relative;}
	.ctrlBlock-item-selectTitle{height:36px;line-height:36px;background-color:#e5e5e5;background-image:url("img/icon/map_downarrow.png");background-repeat:no-repeat;background-size:16px;background-position:right 10px center;border-radius:3px;color:#333;padding:0 10px;cursor:pointer;}
	.ctrlBlock-item-select{width:100%;height:36px;position:absolute;top:0px;left:0px;opacity:0;}
	.ctrlBlock-item-text{width:calc(100% - 0px);height:36px;background:#e5e5e5;color:#333;border:none;border-radius:3px;padding:0 10px;}
	.ctrlBlock-error{color:#dd183d;font-size:12px;margin-bottom:20px;}

	.ctrlBlock-ranging{display:none;}
	.ctrlBlock-ranging-top{}
	.ctrlBlock-ranging-title{float:left;color:#fff;height:30px;line-height:30px;}
	.ctrlBlock-ranging-close{float:right;color:#fff;height:30px;line-height:30px;font-size:24px;cursor:pointer;}
	.ctrlBlock-ranging-main{}
	.ctrlBlock-ranging-poit{text-align:center;margin:30px 0;}
	.ctrlBlock-ranging-poit span{width:60px;height:60px;line-height:60px;text-align:center;font-size:12px;display:inline-block;background:#fdca00;border-radius:50%;box-shadow:0 0 20px rgba(253,200,0,0.4);cursor:pointer;}
	.ctrlBlock-ranging-info{text-align:center;color:#fff;font-size:12px;}
	.ctrlBlock-ranging-info span{color:#fff;font-size:12px;}
</style>
<div id="container" tabindex="0"></div>
<div class="ctrlBlock">
	<div id="edit">
		<div class="ctrlBlock-bg zoom" id="fenceBlock" style="display:none;">
			<ul class="zoom">
				<li class="fenceBlock-type1"><span class="active">点围栏</span></li>
				<li class="fenceBlock-type2"><span class="default">区域围栏</span></li>
				<li class="fenceBlock-type3"><span class="default">省市围栏</span></li>
			</ul>
			<div class="fenceBlock-remove fenceClose">×</div>
		</div>

		<div class="ctrlBlock-bg zoom" id="pointLocal" style="display:none;">
			<div class="zoom" style="margin-bottom:10px;">
				<div class="fence-city" style="float:left;">
					<div class="fence-city-title">省</div>
					<select id="sel_fence_1">
						<option value="">省</option>
					</select>
				</div>
				<div class="fence-city" style="float:right;">
					<div class="fence-city-title">市</div>
					<select id="sel_fence_2">
						<option value="">市</option>
					</select>
				</div>
			</div>

			<div class="fence-search">
				<input type="text" id="search" placeholder="输入要搜索的内容" />
			</div>

			<button class="cbtn" id="search_btn">确定</button>
		</div>
		
		<div class="ctrlBlock-bg zoom" id="regionLocal" style="display:none;">
			<div class="regionLocal-tab zoom">
				<span class="active">地图选点</span>
				<span>手动输入</span>
			</div>
			<div class="regionLocal-choicePoint" id="regionLocal_map">
				<div class="regionLocal-choicePoint-round" id="choice_draw">开始绘制</div>
				<div class="regionLocal-choicePoint-txt">区域围栏至少选择3个边界点</div>
			</div>

			<div class="regionLocal-handPoint" id="regionLocal_hand" style="display:none;">
				<div id="regionLocal_main" style="max-height:300px;overflow-y:scroll;">
					<div class="regionLocal-handPoint-item zoom">
						<div class="regionLocal-handPoint-title">边界点1</div>
						<div class="regionLocal-handPoint-content">
							<div class="regionLocal-handPoint-box zoom">
								<div class="regionLocal-handPoint-txt">北纬</div>
								<div class="regionLocal-handPoint-input"><input type="text" class="regionLocal-handPoint-text" /></div>
							</div>
							<div class="regionLocal-handPoint-box zoom">
								<div class="regionLocal-handPoint-txt">东经</div>
								<div class="regionLocal-handPoint-input"><input type="text" class="regionLocal-handPoint-text" /></div>
							</div>
						</div>
					</div>
				</div>
				<div class="regionLocal-addBtn"><span></span></div>
			</div>

			<div class="regionLocal-btn zoom">
				<button class="cbtn-cancel" id="regionLocal_cancel">取消</button>
				<button class="cbtn" id="regionLocal_btn">确定</button>
			</div>
		</div>

		<div class="ctrlBlock-bg" id="fenceName" style="display:none;">
			<div class="fenceName-title zoom">
				<div class="fenceName-title-txt">区域电子围栏命名</div>
				<div class="fenceName-title-close" id="fenceName_close">×</div>
			</div>
			<div class="fenceName-item">
				<div class="fenceName-item-title">名称(必填)</div>
				<div class="fenceName-item-content">
					<input type="text" class="fenceName-item-text" id="fenceName_name" />
				</div>
			</div>
			<div class="fenceName-item">
				<div class="fenceName-item-title">备注</div>
				<div class="fenceName-item-content">
					<textarea class="fenceName-item-textarea" maxlength="500" id="fenceName_remarks"></textarea>
				</div>
			</div>
			<div class="fenceName-btn zoom">
				<button class="cbtn-cancel" id="fenceName_cancel">取消</button>
				<button class="cbtn" id="fenceName_btn">确定</button>
			</div>
		</div>

		<div class="ctrlBlock-bg" id="provinceLocal" style="display:none;">
			<div class="zoom" style="margin-bottom:10px;">
				<div class="fence-city" style="float:left;">
					<div class="fence-city-title">省</div>
					<select id="sel_province_1">
						<option value="">省</option>
					</select>
				</div>
				<div class="fence-city" style="float:right;">
					<div class="fence-city-title">市</div>
					<select id="sel_province_2">
						<option value="">市</option>
					</select>
				</div>
			</div>

			<button class="cbtn" id="btn_province">确定</button>
		</div>
	</div>

	<div style="text-align:right;" id="newFence">
		<div class="ctrlBlock-bg fenceMore zoom">新建电子围栏</div>
	</div>

	<div style="text-align:right;" id="checkFence">
		<div class="ctrlBlock-bg fenceMore zoom">查看电子围栏明细</div>
	</div>
</div>

<div class="ctrlBlock" style="left:50px;right:auto;">
	<div id="default">
		<div class="ctrlBlock-distance ctrlBlock-bg" id="default_distance">
			<div class="ctrlBlock-distance-top zoom">
				<div class="ctrlBlock-distance-title">路线里程</div>
				<div class="ctrlBlock-distance-more" id="distance_more">路线区间测距 ></div>
			</div>
			<div class="ctrlBlock-distance-main">
				<span id="trajector_distance">--</span>
				<span style="font-size:12px;">公里</span>
			</div>
		</div>
		<div class="ctrlBlock-main ctrlBlock-bg">
			<div class="ctrlBlock-title">车辆轨迹查询</div>
			<div class="ctrlBlock-item">
				<div class="ctrlBlock-item-title">车辆选择</div>
				<div class="ctrlBlock-item-content">
					<div class="ctrlBlock-item-selectTitle">请选择</div>
					<select class="ctrlBlock-item-select" id="carsList">
						<option value="">请选择</option>
					</select>
				</div>
			</div>
			<div class="ctrlBlock-item">
				<div class="ctrlBlock-item-title">开始时间</div>
				<div class="ctrlBlock-item-content">
					<input type="text" class="ctrlBlock-item-text" d-error="请输入开始时间" placeholder="请输入开始时间" id="start" onclick="laydate.render({elem:this,type:'datetime',position:'fixed',btns:['clear', 'confirm'],format:'yyyy-MM-dd HH:mm:ss',theme:'#44bae0',show:true,trigger:'click',max:1});">
				</div>
			</div>
			<div class="ctrlBlock-item">
				<div class="ctrlBlock-item-title">结束时间</div>
				<div class="ctrlBlock-item-content">
					<input type="text" class="ctrlBlock-item-text" d-error="请输入开始时间" placeholder="请输入结束时间" id="end" onclick="laydate.render({elem:this,type:'datetime',position:'fixed',format:'yyyy-MM-dd HH:mm:ss',theme:'#44bae0',show:true,trigger:'click',max:1});">
				</div>
			</div>
			<div class="ctrlBlock-error"></div>
			<button class="cbtn" id="btn">确定</button>
		</div>
	</div>
	
	<div class="ctrlBlock-ranging ctrlBlock-bg" id="ranging">
		<div class="ctrlBlock-ranging-top zoom">
			<div class="ctrlBlock-ranging-title">路线区间测距</div>
			<div class="ctrlBlock-ranging-close" id="ranging_close">×</div>
		</div>
		<div class="ctrlBlock-ranging-main">
			<div class="ctrlBlock-ranging-poit">
				<span id="btn_distance">开始选点</span>
			</div>
			<div class="ctrlBlock-ranging-info">区间总里程：<span id="rangingSunKm">0</span>公里</div>
		</div>
	</div>
</div>

<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
<script type="text/javascript">
	//ajax-getCarsList
	function ajax_get_vehicles(data){
		$.ajax({
			url:ajax_106+'/get_vehicles',
			type:'post',
			dataType:'json',
			async:false,
			data:{
				role_id:data.role_id,
				extra_id:data.extra_id,
			}
		}).then(function(data){
			if(data.code === "0000"){
				fn_getCarsList(data.data);//fn-getCarsList
			}
		});
	}
	var postData = {
		role_id:info_login.data.roleid,
		extra_id:info_login.data.extraid,
	};
	ajax_get_vehicles(postData);

	//fn-getCarsList
	function fn_getCarsList(items){
		if(!items && items.length===0)return false;

		var html = '';
		items.forEach(function(el,index){
			html += '<option value='+el.id+'><font><font>'+el.name+'</font></font></option>';
		});
		$("#carsList").html(html);
	}

	//输入框内容改变
	$(document).off("change","#carsList").on("change","#carsList",function(){
		var sel_txt = $(this).find("option:selected").text();
		$(".ctrlBlock-item-selectTitle").html(sel_txt);
	});

	//地图加载
    var map = new AMap.Map("container", {
        resizeEnable: true,
        mapStyle:'amap://styles/b04f07844c76ca4246706310fe3caba3'
    });

    //按钮点击
    $(document).off("click","#btn").on("click","#btn",function(){
    	var vehicle_id = $("#carsList").val();//获取车辆
    	var startTime = $("#start").val();//获取开始时间
    	var endTime = $("#end").val();//获取结束

    	if(!startTime){
    		$(".ctrlBlock-error").html('请选择开始时间');//提示框
    		return false;
    	}

    	if(!endTime){
			$(".ctrlBlock-error").html('请选择结束时间');//提示框
			return false;
    	}

    	if(startTime >= endTime){
    		$(".ctrlBlock-error").html('开始时间不能大于等结束时间！');//提示框
    		return false;
    	}

    	var data = {
			vehicle_id:vehicle_id,
			start:startTime,
			end:endTime,
		};
		ajax_get_vehicle_trails(data);
    });

    var polyline;
    //ajax-the car position
	function ajax_get_vehicle_trails(data){
		$.ajax({
			url:ajax_106+'/get_vehicle_trails',
			type:'post',
			dataType:'json',
			data:{
				vehicle_id:data.vehicle_id,
				start:data.start,
				end:data.end,
			}
		}).then(function(data){
			if(data.code === "0000"){
				var path = data.data[0].path;
				console.log(path)
				fn_reset_fence();
				//绘制乘车的路线
		        polyline = new AMap.Polyline({
		            map: map,
		            path: path,
		            strokeColor: "#b94b5b",//线颜色
		            strokeOpacity: 1,//线透明度
		            strokeWeight: 4//线宽
		        });
		        map.setCenter(path[0]);
			}
		});
	}

    AMap.plugin(['AMap.ToolBar','AMap.Scale'],function(){
        //map.addControl(new AMap.ToolBar());//工具条-集成了缩放、平移、定位等功能按钮在内的组合控件
        map.addControl(new AMap.Scale());//比例尺-展示地图在当前层级和纬度下的比例尺
	});

    var marker_begin = [];//已添加的标注
    var regionSum = [];//已有区域围栏
    var triangle_lngLat = [];//多边形围栏
    var draw_triangle;//区域围栏线

    var config_location = {};//坐标配置

    var radius = 2000;//电子围栏半径

    var province_isDraw = true;//省市围栏是否可绘制

    //输入提示
    var autoOptions = {
        input: "search"
    };
    var auto = new AMap.Autocomplete(autoOptions);

    var contextMenu = new AMap.ContextMenu();//创建右键菜单
    //地图绑定鼠标右击事件——弹出右键菜单
    map.on('rightclick', function(e) {
        location1 = [e.lnglat.lng,e.lnglat.lat]
        contextMenu.open(map, e.lnglat);
        contextMenuPositon = e.lnglat;
    });

    AMap.event.addListener(auto, "select", select);//注册监听，当选中某条记录时会触发

    var thisCity;
    var placeSearch = new AMap.PlaceSearch({ //构造地点查询类
        pageSize: 5,
        pageIndex: 1,
        city: "021", //城市
    });
    map.getCity(function(re){placeSearch.setCity(re.citycode);thisCity=re.citycode});
    
    //搜索结果
    function select(e,type){
    	var _this;
    	if(e.length>0){
    		_this = e[0];
    	}else{
    		_this = e.poi;
    	}

    	$("#search_btn").removeAttr("disabled");
    	if(!_this.location){
    		toastr.info('无此数据')//提示框
    		$("#search_btn").attr("disabled","disabled");
    		return;
    	}

    	var location = [_this.location.lng,_this.location.lat];

    	var marker = [],//标注
    		_marker = "",//标注替身
    		marker_info = [];//标注信息

    	//fn-绘制标注
		var _marker = fn_marker({
			name:"",
			location:_this.location,
			title:_this.name,
		});

		marker.push(_marker);//保存标注
		marker_info.push(_this);//保存标信息

		map.setCenter(_this.location);//set view center
		map.setZoom(18);//set view zoom

		config_location.center = [_this.location.lng,_this.location.lat];//当前中心点

		var searchNearBy_data = {
			marker:marker,//标注elem
			marker_info:marker_info,//标注信息
			location:_this.location,//标注坐标
		};

		if(type === "区域围栏")return false;
		fn_searchNearBy(searchNearBy_data);//搜索附近
    }

    //搜索附近
    function fn_searchNearBy(data){
		placeSearch.searchNearBy("", data.location, 500, function(status, result) {
		    if (status === 'complete' && result.info === 'OK') {
		    	var items = result.poiList.pois;
	    		items.forEach(function(el,index){
		    		//fn-绘制标注
					var _marker = fn_marker({
						name:el.name,
						location:el.location,
						title:el.name,
					});

		    		data.marker.push(_marker);//保存标注
		    		data.marker_info.push(el);//保存标信息
		    	});
		    }
		    event_marker(data.marker,data.marker_info);//给标注加点击事件
		});
    }

    //给标注加点击事件
    function event_marker(items,items_info){
    	if(items.length>0){
			items.forEach(function(el,index){
				items_info[index].district = items_info[index].district?items_info[index].district:"";
				el.on("click",function(e){
					//fn-生成信息气泡
					fn_infoWindow({
						type:"edit",//类型
						title:items_info[index].name,//标题
				    	address:items_info[index].district+items_info[index].address,//地址
				    	location:items_info[index].location,//标点信息
				    	isEdit:fn_isMarker(items_info[index].location),//是否需要编辑-判断是否已经有重复添加
				    	id:items_info[index].id,
					});
				});
			});
		}
    }

    //ajax-添加电子围栏方案
    function ajax_add_user_electric_fence(_data){
    	var sign = true;
    	$.ajax({
    		url:ajax_106+'/add_user_electric_fence',
    		type:'post',
    		dataType:'json',
    		data:_data,
    		async:false,
    	}).then(function(data){
    		if(data.code === "0000"){
    			toastr.info('创建成功')//提示框
    			if(_data.type == 1){
    				marker_begin.push({
    					id:data.data.id,
	    				lng:data.data.gps_lon,
	    				lat:data.data.gps_lat,
	    			});//已添加的标注
    			}
    			fn_reset_fence();//重置围栏
    		}else{
				sign = false;
    		}
    	});
    	return sign;
    }

    //ajax-获得特定用户的电子围栏
    function ajax_get_user_electricfence(user_id){
    	$.ajax({
    		url:ajax_106+'/get_user_electricfence',
    		type:'post',
    		dataType:'json',
    		data:{
    			user_id:user_id
    		},
    		async:false,
    	}).then(function(data){
    		if(data.code === "0000"){
    			if(data.data && data.data.length>0){
    				fn_set_fence(data.data);
    			}
    		}
    	});
    }

    //ajax-删除电子围栏
    function ajax_delete_electricfence(ids){
    	$.ajax({
    		url:ajax_106+'/delete_electricfence',
    		type:'post',
    		dataType:'json',
    		data:{
    			ids:ids
    		},
    	}).then(function(data){
    		if(data.code === "0000"){
    			toastr.info('删除电子围栏成功')//提示框
    			fn_reset_fence();//重置围栏
    		}
    	});
    }

    //ajax-更新电子围栏
    function ajax_update_user_electricfence(data){
    	$.ajax({
    		url:ajax_106+'/update_user_electricfence',
    		type:'post',
    		dataType:'json',
    		data:data,
    	}).then(function(data){
    		if(data.code === "0000"){
    			toastr.info('更新成功')//提示框
    			fn_sess_remove('fenceInfo');//删除本地存储
    			fn_reset_fence();//重置围栏
    		}
    	});
    }

    //ajax-更新区域围栏
    function ajax_update_user_regionfence(data){
    	$.ajax({
    		url:ajax_106+'/update_user_regionfence',
    		type:'post',
    		dataType:'json',
    		data:data,
    	}).then(function(data){
    		if(data.code === "0000"){
    			toastr.info('更新成功')//提示框
    			fn_sess_remove('fenceInfo');//删除本地存储
    			ctrl.closeFence();//关闭电子围栏
    			fn_reset_fence();//重置围栏
    		}
    	});
    }

    //fn-列出已有电子围栏
    function fn_set_fence(items){
    	//已添加的标注
	    marker_begin = [];
    	items.forEach(function(el,index){
    		if(el.type == 1){
	    		var location = [el.gps_lon,el.gps_lat];
	    		
	    		marker_begin.push({
	    			id:el.id,
	    			lng:el.gps_lon,//经度
	    			lat:el.gps_lat,//纬度
	    		});

	    		//fn-绘制图形
				fn_draw({
					type:"round",
					location:location,
					radius:el.radius,
				});

		    	//fn-绘制标注
				var _marker = fn_marker({
					name:el.name,
					location:location,
					title:el.location_name,
				});

		    	_marker.on("click",function(){
		    		//fn-生成信息气泡
					fn_infoWindow({
						type:"default",//类型
						title:el.location_name,//标题
				    	address:el.poi_name,//地址
				    	location:location,//标点信息
				    	isEdit:false,//是否需要编辑-判断是否已经有重复添加,//是否需要编辑
				    	id:el.id,
					});
		    	});
			}else{
				//format-坐标解析格式
				var path = format_location(JSON.parse(el.points));
				//fn-绘制图形
				var polygon = fn_draw({
					type:"triangle",
					path:path,
					extData:{
				    	id:el.id,
				    	name:el.name,
				    	position:path[0],
				    }
				});

				polygon.on("click",function(){
					//fn-生成信息气泡
					fn_infoWindow({
						type:"default",//类型
						title:this.getExtData().name,//标题
				    	address:"",//地址
				    	location:this.getExtData().position,//标点信息
				    	isEdit:false,//是否需要编辑-判断是否已经有重复添加,//是否需要编辑
				    	id:el.id,
					});
				});
			}
    	});
    }

    //ajax-添加省市围栏
    function ajax_add_user_regionfence(_data){
    	var sign = true;
    	$.ajax({
    		url:ajax_106+'/add_user_regionfence',
    		type:'post',
    		dataType:'json',
    		data:_data,
    		async:false,
    	}).then(function(data){
    		if(data.code === "0000"){
    			toastr.info('创建成功')//提示框
    			
    		}else{
				sign = false;
    		}
    	});
    	return sign;
    }

    //ajax-获取省市围栏
    function ajax_get_user_regionfence(name){
    	$.ajax({
    		url:ajax_106+'/get_user_regionfence',
    		type:'post',
    		dataType:'json',
    		data:{user_id:info_login.data.id},
    		async:false,
    	}).then(function(data){
    		if(data.code === "0000"){
    			fn_set_region(data.data,name);//fn-列出已有区域围栏
    		}
    	});
    }

    //fn-列出已有区域围栏
    function fn_set_region(items,name){
    	items.forEach(function(el,index){
    		if(el.name == name && name){
    			
    		}else{
    			regionSum.push(el);
	    		var statistics_codes = el.statistics_codes.split(",");
	    		var code = statistics_codes[0];
	    		if(statistics_codes.length>1)code=statistics_codes[1];
	    		fn_region({adcode:code});//区域围栏
    		}
    		
    	});
    }

    //判断是否已经有重复添加
	function fn_isMarker(position){
		if(!marker_begin || marker_begin.length==0)return false;
		var sign = false;
		marker_begin.forEach(function(el,index){
	    	if(position.lng == el.lng && position.lat == el.lat){
	    		sign = el.id;
	    	}
	    });//已添加的标注
	    return sign;
	}

	//判断是否已经有重复添加-区域围栏
	function fn_isRegion(data){
		var sign = true;
		regionSum.forEach(function(el,index){
	    	if(el.name === data){
	    		sign = false;
	    	}
	    });//已添加的标注
	    return sign;
	}

	//format-坐标解析格式
	function format_location(arrs){
		var path = [];
		arrs.forEach(function(el,index){
			path.push(new AMap.LngLat(el[0],el[1])); 
		});
		return path;
	}

	//ajax-获取全部省
    function ajax_get_all_provinces(){
    	$.ajax({
    		url:ajax_106+'/get_all_provinces',
    		type:'post',
    		dataType:'json',
    		async:false,
    	}).then(function(data){
    		if(data.code === "0000"){
    			var data = data.data;

    			if(data.length===0){
    				toastr.error('');//提示框
    				return false;
    			}

    			var html = '<option value=""><font><font>省</font></font></option>';

    			data.forEach(function(el,index){
    				el.gaode_code = el.gaode_code?el.gaode_code:"";
    				html += '<option value='+el.code+' d-pcode="'+el.gaode_code+'"><font><font>'+el.name+'</font></font></option>';
    			});
    			$("#province,#province_region").html(html);

    			$("#sel_fence_1").html(html);
    			$("#sel_province_1").html(html);
    		}
    	});
    }

    //ajax-获取特定省下的城市
    function ajax_get_province_citys(code){
    	$.ajax({
    		url:ajax_106+'/get_province_citys',
    		type:'post',
    		dataType:'json',
    		data:{
    			code:code
    		},
    		async:false,
    	}).then(function(data){
    		if(data.code === "0000"){
    			data = data.data;
    			if(data.length===0){
    				toastr.error('');//提示框
    				return false;
    			}

    			var html = '<option value=""><font><font>市</font></font></option>';

    			data.forEach(function(el,index){
    				html += '<option value='+el.analysis_code+' d-code='+el.code+'><font><font>'+el.name+'</font></font></option>';
    			});

    			$("#sel_fence_2").html(html);
    			$("#sel_province_2").html(html);
    		}
    	});
    }

	//fn-绘制图形
	//config:{
	//		type:"",//类型round:圆,triangle:多边形
	//		location:[],//圆的中心点
	//		path:[],//多边形的坐标组
	//		radius:num,//圆的半径
	//		extData:{},//多边形参数
	//}
	function fn_draw(config){
		var fillColor = "#ee8754";
		if(config.fillColor && config.fillColor==="预览"){
			fillColor = "#ee8754";
		}

		function round(){
			//配置电子围栏
			var circle = new AMap.Circle({
			    center: config.location,
			    radius: config.radius,
			    fillOpacity:0.2,
			    fillColor:fillColor,
			    strokeWeight:1,
			    strokeColor:fillColor,
			    bubble:true,
			});
			circle.setMap(map);//生成电子围栏
			return circle;
		}

		function triangle(){
			//配置区域围栏
			var polygon = new AMap.Polygon({
			    path: config.path,//format-坐标解析格式
			    fillOpacity:0.2,
			    fillColor:fillColor,
			    strokeOpacity: 1,
            	strokeWeight: 3,
            	strokeColor:fillColor,
			    map:map,
			    extData:config.extData,
			});
			return polygon;
		}

		switch(config.type){
			case "round":
				return round();
				break;
			case "triangle":
				return triangle();
				break;
		}
	}

	//fn-绘制标注
	//config:{
	//		name:"",//名称
	//		location:[],//经纬度
	//		title:"",//地标名
	//}
	function fn_marker(config){
		//配置标注
    	var marker = new AMap.Marker({
    		label: {
                content: config.name,
                offset: new AMap.Pixel(15, 30)
            },
			position:config.location,
			title: config.title,
			map: map,
		});
		return marker;
	}

	//fn-生成信息气泡
	//config:{
	//		title:"",//标题
	//		address:"",//地址
	//		location:"",//经纬度
	//		isEdit:"",//是否需要编辑-电子围栏ID
	//}
	function fn_infoWindow(config){
		if(config.isEdit && !config.id)config.type="default";
		//信息载体窗口
		var infoWindow = new AMap.InfoWindow({
		    isCustom: true,  //使用自定义窗体
		    content: call_infoBlockHtml({//call-自动生成HTML
		    	type:config.type,//类型
		    	title:config.title,//标题
		    	address:config.address,//地址
		    	position:config.location,//标点信息
		    	isEdit:config.isEdit,//是否需要编辑-电子围栏ID
		    	id:config.id,
		    }),
		    offset: new AMap.Pixel(0,-70)//定位
		});
		infoWindow.open(map, config.location);//加载信息载体窗口
	}

    //返回信息提示层样式
	function call_infoBlockHtml(config){
		if(!config){
    		console.error("请传入对象参数");
    		return false;
    	}
    	var location = config_location.center;

    	var name = "",
    		radius = "";
    	if(config.isEdit && config.id){
    		var fenceInfo = JSON.parse(window.sessionStorage.fenceInfo);
    		name=fenceInfo.name;
    		radius = fenceInfo.radius;
    	}

		var html = '<div class="infoBlock">'+config.title+'</div>';

		var html_default = '<div class="infoBlock"><div class="infoBlock-default"><div class="infoBlock-default-title">'+config.title+'</div><div class="infoBlock-default-txt">'+config.address+'</div><div class="infoBlock-default-btn zoom" d-id="'+config.id+'"><button class="cbtn-cancel ibtn-close">取消</button><button class="cbtn" id="fence_remove">删除电子围栏</button></div></div></div>';

		var html_edit = '<div class="infoBlock"><div class="infoBlock-edit"><div class="infoBlock-edit-title zoom"><span class="infoBlock-edit-t1">'+config.title+'</span><span class="infoBlock-edit-t2">'+config.address+'</span></div><div class="infoBlock-edit-item zoom"><div class="infoBlock-edit-tle">电子围栏名称</div><div class="infoBlock-edit-cnt"><input type="text" placeholder="请输入电子围栏名称" class="infoBlock-edit-text" id="fence_name" value="'+name+'" /></div></div><div class="infoBlock-edit-item zoom"><div class="infoBlock-edit-tle">电子围栏半径</div><div class="infoBlock-edit-cnt"><div class="infoBlock-edit-defaultRadio zoom"><span d-radius="2000">2km</span><span d-radius="10000">10km</span><span d-radius="100000">100km</span><span d-radius="20000000">20000km</span></div><div class="infoBlock-edit-box zoom"><input type="text" placeholder="自定义电子围栏半径" class="infoBlock-edit-text" id="fence_radius" value="'+radius+'" /><span>m</span></div><div class="infoBlock-edit-button"><button class="cbtn" id="fence_save">确定</button><button class="cbtn-cancel" id="fence_cancel">取消</button></div></div></div></div></div>';

		var round = fn_draw({
			type:"round",
			location:location,
			radius:0,
			fillColor:"预览",
		});
		if(config.type === "default"){
			html = html_default;
		}else if(config.type === "edit"){
			html = html_edit;

			//点击电子围栏半径
			$(document).off("click",".infoBlock-edit-defaultRadio span").on("click",".infoBlock-edit-defaultRadio span",function(){
				$(".infoBlock-edit-defaultRadio").each(function(index,el){
					$(".infoBlock-edit-defaultRadio").eq(index).find("span").removeClass("active");
				});
				$(this).addClass("active");

				$("#fence_radius").val("");

				radius = $(this).attr("d-radius");
				round.setRadius(radius);
			});

			//修改电子围栏半径
			$(document).off("keyup","#fence_radius").on("keyup","#fence_radius",function(){
				$(".infoBlock-edit-defaultRadio").each(function(index,el){
					$(".infoBlock-edit-defaultRadio").eq(index).find("span").removeClass("active");
				});
				radius = $(this).val();
				if(isNaN(radius)){
					toastr.error("半径输入不正确");
					return;
				}
				round.setRadius(radius);
			});

			//点击取消
			$(document).off("click","#fence_cancel").on("click","#fence_cancel",function(){
				round.setRadius(0);
				map.clearInfoWindow();
			});

			//点击保存
			$(document).off("click","#fence_save").on("click","#fence_save",function(){
				var name = $("#fence_name").val();
				if(!name){
					toastr.error('请输入电子围栏名称');//提示框
					return;
				}else if(!radius){
					toastr.error('请选择或输入电子围栏半径');//提示框
					return;
				}

				if(isNaN(radius)){
					toastr.error("半径输入不正确");
					return;
				}

				var extra = {
					zoom:map.getZoom(),//缩放视图比例
					center:{lng:location[0],lat:location[1]},//中心点
				};

				var postData;
				if(config.isEdit && config.id){
					postData = {
						id:config.id,
						name:name,
						radius:radius,
						extra:JSON.stringify(extra),//其他参数
					};
					ajax_update_user_electricfence(postData);//ajax-更新电子围栏
					return;
				}

				postData = {
					name:name,//电子围栏名称
					user_id:info_login.data.id,//用户ID
					username:info_login.data.username,//用户名
					location_name:config.title,//坐标名称
					poi_name:config.address,//坐标地址
					gps_lon:config.position.lng,//经度
					gps_lat:config.position.lat,//纬度
					type:1,//图形（1：圆，2：多边形）
					radius:radius,//电子围栏半径
					extra:JSON.stringify(extra),//其他参数
				};

				ajax_add_user_electric_fence(postData);//ajax-添加电子围栏方案
			});
		}
		
		return html;
	}

    //保存前验证
	function Verification(){
		var sign = true;
		$(".verification").each(function(index,el){
			if($.trim($(".verification").eq(index).val())=="" && $(".verification").eq(index).attr("d-if")=="true"){
				toastr.error($(".verification").eq(index).attr("d-error"));//提示框
				sign = false;
			}
		});
		return sign;
	}

	//操作
	function fn_operation_ctrlBlock(){
		var _this = this;
		//打开新建电子围栏
		this.openFence = function(){
			$("#edit").show();
			$("#fenceBlock").show();
			$("#pointLocal").show();
			$("#newFence").hide();
			$("#fenceBlock li span").each(function(index,el){
    			$("#fenceBlock li").find("span").attr("class","default");
    		});
    		$("#fenceBlock li span").eq(0).attr("class","active");
		},
		//关闭电子围栏
		this.closeFence = function(){
			$("#edit").hide();
			$("#fenceBlock").show();
			$("#pointLocal").show();
			$("#regionLocal").hide();
			$("#fenceName").hide();
			$("#provinceLocal").hide();
			$("#newFence").show();
		},
		//开启点围栏
		this.pointLocal = function(){
			$("#pointLocal").show();
			$("#regionLocal").hide();
			$("#fenceName").hide();
			$("#provinceLocal").hide();
			_this.tab("点围栏");
		},
		//开启区域围栏
		this.regionLocal = function(){
			$("#regionLocal").show();
			$("#pointLocal").hide();
			$("#fenceName").hide();
			$("#provinceLocal").hide();
			_this.tab("区域围栏");
		},
		//开启区域围栏-地图选点
		this.regionLocal_map = function(){
			$("#regionLocal").show();
			$("#fenceBlock").show();
			$("#regionLocal_map").show();
			$("#regionLocal_hand").hide();
			$("#fenceName").hide();
		},
		//开启区域围栏-手动选点
		this.regionLocal_hand = function(){
			$("#regionLocal_hand").show();
			$("#regionLocal_map").hide();
			$("#fenceName").hide();
		},
		//开启区域围栏-名称
		this.regionLocal_fenceName = function(){
			$("#fenceName").show();
			$("#regionLocal").hide();
			$("#fenceBlock").hide();
		},
		//开启省市围栏
		this.provinceLocal = function(){
			$("#provinceLocal").show();
			$("#regionLocal").hide();
			$("#fenceName").hide();
			$("#pointLocal").hide();
			_this.tab("省市围栏");
		},
		this.tab = function(tab){
			$("#fenceBlock li span").each(function(index,el){
    			$("#fenceBlock li").find("span").attr("class","default");
    		});
    		var index = 0;
    		if(tab === "区域围栏"){
    			index = 1;
    		}else if(tab === "省市围栏"){
    			index = 2;
    		}
    		$("#fenceBlock li").eq(index).find("span").attr("class","active");
		}
	}
	var ctrl = new fn_operation_ctrlBlock();

    //预览和编辑
    function init(){
    	if(!window.sessionStorage.fenceInfo){
    		if(info_login.data.provincecode){
				map.setCity(info_login.data.provincecode);
			}else{
				map.getCity(function(re){map.setCity(re.citycode)});//设置当前城市
			}
    		return false;
    	}
    	var fenceInfo = JSON.parse(window.sessionStorage.fenceInfo);
    	var extra = JSON.parse(fenceInfo.extra);
    	console.log(fenceInfo);

    	map.setCenter([extra.center.lng,extra.center.lat]);
    	map.setZoom(extra.zoom);

    	if(!fenceInfo.isEdit)return;

    	if(fenceInfo.type === "省市围栏"){
			fence_province();//fence-省市围栏
    	}else if(fenceInfo.type === "点围栏"){
    		fence_point();//fence-点围栏
    	}

    	//fence-省市围栏
    	function fence_province(){
    		ctrl.openFence();//打开新建电子围栏
    		ctrl.provinceLocal();//开启省市围栏

    		var statistics_codes = fenceInfo.statistics_codes.split(",");
    		province_isDraw = false;//省市围栏是否可绘制
    		$("#sel_province_1").val(statistics_codes[0]);
    		$("#sel_province_1").change();
    		if(statistics_codes.length>1){
    			$("#sel_province_2").val(statistics_codes[1]);
    			$("#sel_province_2").change();
    		}
    	}

    	//fence-点围栏
    	function fence_point(){
    		ctrl.openFence();//打开新建电子围栏
    		ctrl.pointLocal();//开启点围栏


			var lngLat = [fenceInfo.gps_lon,fenceInfo.gps_lat];
			var name = fenceInfo.name;
			var location_name = fenceInfo.location_name;
			var address = fenceInfo.poi_name;
			var id = fenceInfo.id;
			
			//fn-绘制标注
			var _marker = fn_marker({
				name:name,
				location:lngLat,
				title:address
			});

			config_location.center = lngLat;

	    	_marker.on("click",function(){
	    		//fn-生成信息气泡
				fn_infoWindow({
					type:"edit",//类型
					title:location_name,//标题
			    	address:address,//地址
			    	location:lngLat,//标点信息
			    	isEdit:true,//是否需要编辑-判断是否已经有重复添加,//是否需要编辑
			    	id:id
				});
	    	});
    	}
    }

    //设置该元素是否参与校验
    function fn_verification_set(elem,bool){
    	elem.attr("d-if",bool);
    }

    //窗口-编辑电子围栏-清空
    function box_edit_clear(){
    	$(".boxAlert-title").html("");
		$("#fence_name").val("");
		$("#fence_radius").val("");
		$("#radius_box").hide();
		$(".boxAlert-item-btn span").removeClass("active");
		$(".boxAlert-item-btn span:first").addClass("active");
		$(".verification").attr("d-if","false");//设置该元素是否参与校验
		$("#province,#province_region").val("");
		$("#city,#city_region").val("");
		$("#search").val("");
    }

    //重置围栏
    function fn_reset_fence(config){
    	var name;
    	//去重
    	if(typeof config == "object" && config.info == "区域围栏")name = config.name;

    	map.clearMap();//移除覆盖物
    	$("#fenceName_name").val("");//区域围栏名称
    	$("#fenceName_remarks").val("");//区域围栏备注
    	ajax_get_user_electricfence(info_login.data.id);//ajax-获得特定用户的电子围栏
    	ajax_get_user_regionfence(name)//ajax-获取区域围栏
    }

	//重置区域围栏绘制
	function fn_draw_regionLocal(){
		triangle_lngLat = [];//多边形围栏
		$("#choice_draw").html("开始绘制");
		map.off("click",fn_mapClick);
	}

	//区域围栏-地图选点
	function fn_mapClick(e){
		var LngLat = [e.lnglat.lng,e.lnglat.lat];
		triangle_lngLat.push(LngLat);//区域围栏

		//区域围栏-凸多边形校验
		if(!judge_convex_polygon(triangle_lngLat)){
			toastr.error('不是凸多边形,请按顺时针或逆时针绘制');//提示框
			triangle_lngLat.splice(triangle_lngLat.length-1,1);
			return;
		}

        draw_triangle.setPath(triangle_lngLat);
        triangle_lngLat = triangle_lngLat.noRepeat_fence();//去重	

        //fn-绘制标注
        fn_marker({
        	name:triangle_lngLat.length,
        	location:LngLat,
        });
    }

    //区域围栏-凸多边形校验
    function judge_convex_polygon(points){
    	if(points.length<4)return true;
    	console.log(points)

    	function judge_point_2_line_position(x1,y1,x2,y2,x3,y3,x4,y4){
            res1=(x1-x3)*(y2-y3)-(y1-y3)*(x2-x3);
            res2=(x1-x3)*(y4-y3)-(y1-y3)*(x4-x3);
            if(res1*res2<=0){
                return true;
            }else{
                return false;
            }
        }
        //        x1 x3连线
        x1=points[0].lng;
        y1=points[0].lat;
        x3=points[points.length-2][0];
        y3=points[points.length-2][1];

        x2=points[1][0];
        y2=points[1][1];
        x4=points[points.length-1][0];
        y4=points[points.length-1][1];
        if(!judge_point_2_line_position(x1,y1,x2,y2,x3,y3,x4,y4)){
            console.log(0)
            return false
        }

        x1=points[points.length-1][0];
        y1=points[points.length-1][1];
        x3=points[1][0];
        y3=points[1][1];

        x2=points[points.length-2][0];
        y2=points[points.length-2][1];
        x4=points[0].lng;
        y4=points[0].lat;
        if(!judge_point_2_line_position(x1,y1,x2,y2,x3,y3,x4,y4)){
            console.log(1)
            return false
        }

        x1=points[points.length-1][0];
        y1=points[points.length-1][1];
        x3=points[points.length-3][0];
        y3=points[points.length-3][1];

        x2=points[points.length-2][0];
        y2=points[points.length-2][1];
        x4=points[0].lng;
        y4=points[0].lat;
        if(!judge_point_2_line_position(x1,y1,x2,y2,x3,y3,x4,y4)){
            console.log(2)
            return false
        }

        return true

        // x1=points[0].lng;
        // y1=points[0].lat;

        // x2=points[1][0];
        // y2=points[1][1];

        // x3=points[points.length-2][0];
        // y3=points[points.length-2][1];

        // x4=points[points.length-1][0];
        // y4=points[points.length-1][1];

        // res1=(x1-x3)*(y2-y3)-(y1-y3)*(x2-x3);
        // res2=(x1-x3)*(y4-y3)-(y1-y3)*(x4-x3);

        // if(res1*res2<0){
        //     return true;
        // }else{
        //     return false;
        // }
    }

	//省市围栏
	function fn_region(data){
		//加载DistrictExplorer，loadUI的路径参数为模块名中 'ui/' 之后的部分 
		AMapUI.loadUI(['geo/DistrictExplorer'], function(DistrictExplorer) {
		   //启动页面
		   initPage(DistrictExplorer,data.adcode);
		});

		//区域围栏
		function initPage(DistrictExplorer,adcode) {
		    //创建一个实例
		    var districtExplorer = new DistrictExplorer({
		        map:map, //关联的地图实例
		        eventSupport: true, //打开事件支持
		    });

		    districtExplorer.loadAreaNode(adcode, function(error, areaNode) {
		        if(error){
		            console.error(error);
		            return;
		        }

		        //绘制载入的区划节点
		        renderAreaNode(districtExplorer, areaNode);
		    });
		}

		function renderAreaNode(districtExplorer, areaNode) {
			//清除已有的绘制内容
			districtExplorer.clearFeaturePolygons();
			//绘制父级区划，仅用黑色描边
			districtExplorer.renderParentFeature(areaNode, {
				cursor: 'default',
				bubble: true,
				strokeColor: 'black', //线颜色
				fillColor: "#999999",
				fillOpacity: 0.35, //填充透明度
				strokeWeight: 3, //线宽
			});

			//更新地图视野以适合区划面
			districtExplorer.getAllFeaturePolygons();
			// districtExplorer.on("featureClick",function(e,feature){
			// 	fn_reset_fence();//重置围栏
				
			// 	//清除已有的绘制内容
			// 	districtExplorer.clearFeaturePolygons();
			// 	//绘制父级区划，仅用黑色描边
			// 	districtExplorer.renderParentFeature(areaNode, {
			// 		cursor: 'default',
			// 		bubble: true,
			// 		strokeColor: 'black', //线颜色
			// 		fillColor: "#3366cc",
			// 		fillOpacity: 0.8, //填充透明度
			// 		strokeWeight: 3, //线宽
			// 	});

			// 	//更新地图视野以适合区划面
			// 	districtExplorer.getAllFeaturePolygons();
			// });
			//map.setFitView(districtExplorer.getAllFeaturePolygons());
		}
	}

	//画围栏-省市围栏
	function fn_draw_province(text,code){
		fn_reset_fence();//重置围栏

		if(fn_isRegion(text)){
			fn_region({adcode:code});//省市围栏
		}
		
		placeSearch.search(text, function(status, result) {
			if(status === 'complete' && result.info === 'OK'){
				select(result.poiList.pois,"区域围栏");
				map.setZoom(8);
			}else{
				toastr.error('无此数据');//提示框
			}
		});
	}

    $(function(){
    	ajax_get_all_provinces();//ajax-获取全部省
    	ajax_get_user_regionfence();//ajax-获取区域围栏
    	ajax_get_user_electricfence(info_login.data.id);//ajax-获得特定用户的电子围栏
    	setTimeout(init,1000);
    	//init();//预览和编辑

    	//点击打开新建电子围栏
    	$(document).off("click","#newFence").on("click","#newFence",function(){
    		ctrl.openFence();//打开新建电子围栏
    	});

    	//点击关闭新建电子围栏
    	$(document).off("click",".fenceClose").on("click",".fenceClose",function(){
    		ctrl.closeFence();//打开关闭电子围栏
    		fn_reset_fence();//重置电子围栏
    		fn_draw_regionLocal();//重置区域围栏绘制
    	});

    	//点击切换选项卡
    	$(document).off("click","#fenceBlock li").on("click","#fenceBlock li",function(){
    		$("#fenceBlock li span").each(function(index,el){
    			$("#fenceBlock li").find("span").attr("class","default");
    		});
    		$(this).find("span").attr("class","active");

    		var sign = $(this).find("span").html();
    		if(sign === "点围栏"){
    			ctrl.pointLocal();//开启点围栏
    		}else if(sign === "区域围栏"){
    			ctrl.regionLocal();//开启点围栏
    		}else if(sign === "省市围栏"){
    			ctrl.provinceLocal();//开启点围栏
    		}

    		fn_reset_fence();//重置电子围栏
    		fn_draw_regionLocal();//重置区域围栏绘制
    	});

    	//点击切换区域围栏选项卡
    	$(document).off("click",".regionLocal-tab span").on("click",".regionLocal-tab span",function(){
    		$(".regionLocal-handPoint-item").each(function(index,el){
    			if(index === 0)return;
    			console.log(index)
    			$(".regionLocal-handPoint-item").eq(index).remove();
    		});
    		$(".regionLocal-handPoint-text").val("");

    		$(".regionLocal-tab span").each(function(index,el){
    			$(".regionLocal-tab span").removeClass("active");
    		});
    		$(this).addClass("active");

    		var sign = $(this).html();
    		if(sign === "地图选点"){
    			ctrl.regionLocal_map();//开启区域围栏-地图选点
    		}else if(sign === "手动输入"){
    			ctrl.regionLocal_hand();//开启区域围栏-手动选点
    		}

    		fn_reset_fence();//重置电子围栏
    		fn_draw_regionLocal();//重置区域围栏绘制
    	});

    	//下拉框内容改变
    	$(document).off("change",".fence-city select").on("change",".fence-city select",function(){
    		$(this).siblings(".fence-city-title").html($(this).find("option:selected").text());
    	});

    	//点击删除电子围栏
    	$(document).off("click","#fence_remove").on("click","#fence_remove",function(){
    		var id = $(this).parent().attr("d-id");
			new msgAlert({info:"确定要删除此电子围栏吗？删除后无法恢复。"}).on("btnOkClick",function(){
				ajax_delete_electricfence("["+id+"]");//ajax-删除电子围栏
			});
		});

		//event-点击关闭信息载体窗口
		$(document).off("click",".ibtn-close").on("click",".ibtn-close",function(){
			map.clearInfoWindow();
		});

    	//回车查找
    	$(document).off("click","#search").off("keydown","#search").on("keydown","#search",function(e) {
	        if (e.keyCode == 13) {
				placeSearch.search($(this).val(), function(status, result) {
					if(status === 'complete' && result.info === 'OK'){
						select(result.poiList.pois);
					}else{
						toastr.error('无此数据');//提示框
					}
				});
	        }
	    });

    	//点击查找
	    $(document).off("click","#search_btn").on("click","#search_btn",function(){
	    	var search = $("#search").val();
	    	if(!search){
	    		toastr.error('请输入查找的内容');//提示框
	    		return;
	    	}
	    	placeSearch.search(search, function(status, result) {
	    		console.log(result.info)
				if(status === 'complete' && result.info === 'OK'){
					select(result.poiList.pois);
				}else{
					toastr.error('无此数据');//提示框
				}
			});
	    });

		//选中特定省份-点围栏
		$("#sel_fence_1").change(function(){
			if($(this).val()){
				placeSearch.setCity($(this).val());//城市
				auto.setCity($(this).val());//城市
				ajax_get_province_citys($(this).val());//ajax-获取特定省下的城市
			}else{
				map.getCity(function(re){placeSearch.setCity(re.citycode)});//设置当前城市
				$("#sel_fence_2").html('<option value=""><font><font>市</font></font></option>');
			}
			$("#sel_fence_2").change();//城市改变-点围栏
		});

		//城市改变-点围栏
		$("#sel_fence_2").change(function(){
			if($(this).val()){
			    placeSearch.setCity($(this).val());//城市
			    auto.setCity($(this).val());//城市
			}
		});

		//选中特定省份-省市围栏
		$("#sel_province_1").change(function(){
			if($(this).val()){
				placeSearch.setCity($(this).val());//城市
				auto.setCity($(this).val());//城市

		    	var province_code = $(this).find("option:selected").attr("d-pcode")?$(this).find("option:selected").attr("d-pcode"):$(this).val();//获取省份codeID
		    	config_location.region_code = province_code;//区域围栏地域code
				config_location.regionName = $(this).find("option:selected").text();//坐标名称
				config_location.regionType = 1;//区域围栏类型
				config_location.statistics_codes = [$(this).val()];//统计局编码

				ajax_get_province_citys($(this).val());//ajax-获取特定省下的城市

				var province_text = $(this).find("option:selected").text();
				if(province_isDraw)fn_draw_province(province_text,$(this).val());//画围栏-省市围栏
				province_isDraw = true;//省市围栏是否可绘制
			}else{
				map.getCity(function(re){placeSearch.setCity(re.citycode)});//设置当前城市
				$("#sel_province_2").html('<option value=""><font><font>市</font></font></option>');
			}
			$("#sel_province_2").change();//城市改变-省市围栏
		});

		//城市改变-省市围栏
		$("#sel_province_2").change(function(){
			if($(this).val()){
			    placeSearch.setCity($(this).val());//城市
			    auto.setCity($(this).val());//城市
			    var city = $(this).find("option:selected").text();//获取城市
				var city_code = $(this).val();//获取城市codeID
				var city_dcode = $(this).find("option:selected").attr("d-code");//获取城市code
				config_location.region_code = city_dcode;//区域围栏地域code
	    		config_location.regionName = city;//坐标名称
	    		config_location.regionType = 2;//区域围栏类型
	    		config_location.statistics_codes[1] = city_code;//统计局编码

	    		if(province_isDraw)fn_draw_province(city,$(this).val());//画围栏-省市围栏
				province_isDraw = true;//省市围栏是否可绘制
			}
		});

		//点击确定-省区域
		$(document).off("click","#btn_province").on("click","#btn_province",function(){
			var province = $("#sel_province_1").val();
			var city = $("#sel_province_2").val();
			var code = province;

			var province_text = $("#sel_province_1").find("option:selected").text();
			var city_text = $("#sel_province_2").find("option:selected").text();
			var code_text = province_text;

			if(city){
				code = city;
				code_text = city_text;
			}

			var extra = {
				zoom:map.getZoom(),//缩放视图比例
				center:map.getCenter(),//中心点
			};

			if(!fn_isRegion(code_text)){
				toastr.error('已有省市围栏'+code_text);//提示框
				return;
			}

			var postData;
			if(window.sessionStorage.fenceInfo){
				var fenceInfo = JSON.parse(window.sessionStorage.fenceInfo);
				if(fenceInfo.type === "省市围栏"){
					postData = {
						id:fenceInfo.id,
						name:code_text,
						region_code:config_location.region_code,
						type:config_location.regionType,//类形（1：省，2：市）
						statistics_codes:config_location.statistics_codes.join(","),//统计局编码
						extra:JSON.stringify(extra),//其他参数
					};
					ajax_update_user_regionfence(postData);
					return;
				}
			}

			postData = {
				name:code_text,//围栏名称
				user_id:info_login.data.id,//用户ID
				username:info_login.data.username,//用户名
				location_name:"",//坐标名称
				region_code:config_location.region_code,
				type:config_location.regionType,//类形（1：省，2：市）
				statistics_codes:config_location.statistics_codes.join(","),//统计局编码
				extra:JSON.stringify(extra),//其他参数
			};

			//ajax-添加省市围栏
			if(ajax_add_user_regionfence(postData)){
				ctrl.closeFence();//关闭电子围栏
			};
		});

		//开始绘制-区域围栏
		$(document).off("click","#choice_draw").on("click","#choice_draw",function(){
			triangle_lngLat = [];
			if($(this).html() === "重新绘制"){
				fn_reset_fence();//重置电子围栏
			}

			$(this).html("重新绘制");

			draw_triangle = fn_draw({
				type:"triangle",
				path:[],
			});
			
			map.off('click',fn_mapClick).on('click',fn_mapClick);
		});

		//点击添加-区域围栏-手动输入
		$(document).off("click",".regionLocal-addBtn span").on("click",".regionLocal-addBtn span",function(){
			var len = $(".regionLocal-handPoint-item").length+1;
			if(len > 8){
				toastr.error('最多八个点');//提示框
				return;
			}
			var html = '<div class="regionLocal-handPoint-item zoom"><div class="regionLocal-handPoint-title">边界点'+len+'</div><div class="regionLocal-handPoint-content"><div class="regionLocal-handPoint-box zoom"><div class="regionLocal-handPoint-txt">北纬</div><div class="regionLocal-handPoint-input"><input type="text" class="regionLocal-handPoint-text" /></div></div><div class="regionLocal-handPoint-box zoom"><div class="regionLocal-handPoint-txt">东经</div><div class="regionLocal-handPoint-input"><input type="text" class="regionLocal-handPoint-text" /></div></div></div></div>';

			$("#regionLocal_main").append(html);
		});

		//失去焦点-区域围栏-手动输入
		$(document).off("blur",".regionLocal-handPoint-text").on("blur",".regionLocal-handPoint-text",function(){
			var lnglat = [];
			var _items = $(".regionLocal-handPoint-item");

			$(".regionLocal-handPoint-item").each(function(index,el){
				var lat = $(".regionLocal-handPoint-item").eq(index).find(".regionLocal-handPoint-text").eq(0).val();
				var lng = $(".regionLocal-handPoint-item").eq(index).find(".regionLocal-handPoint-text").eq(1).val();

				if(lng && lat){
					var re_lat = /^([0-8]?\d{1}\.\d{0,6}|90\.0{0,6}|[0-8]?\d{1}|90)$/;
					var re_lng = /^(((\d|[1-9]\d|1[1-7]\d|0)\.\d{0,6})|(\d|[1-9]\d|1[1-7]\d|0{1,3})|180\.0{0,6}|180)$/;

					if(!re_lat.test(lat) || lat == parseInt(lat)){
						toastr.error('边界点'+(index+1)+'：请输入正确的纬度');//提示框
						return;
					}

					if(!re_lng.test(lng) || lng == parseInt(lng)){
						toastr.error('边界点'+(index+1)+'：请输入正确的经度');//提示框
						return;
					}

					lnglat.push({lng:lng,lat:lat});
				}
			});
			fn_reset_fence();//重置电子围栏

			triangle_lngLat = [];
			draw_triangle = fn_draw({
				type:"triangle",
				path:[],
			});

			lnglat.forEach(function(el){
				fn_mapClick({
					lnglat:{lng:el.lng,lat:el.lat}
				});
			});
		});

		//点击取消-区域围栏
		$(document).off("click","#regionLocal_cancel").on("click","#regionLocal_cancel",function(){
			var html = '<div class="regionLocal-handPoint-item zoom"><div class="regionLocal-handPoint-title">边界点1</div><div class="regionLocal-handPoint-content"><div class="regionLocal-handPoint-box zoom"><div class="regionLocal-handPoint-txt">北纬</div><div class="regionLocal-handPoint-input"><input type="text" class="regionLocal-handPoint-text" /></div></div><div class="regionLocal-handPoint-box zoom"><div class="regionLocal-handPoint-txt">东经</div><div class="regionLocal-handPoint-input"><input type="text" class="regionLocal-handPoint-text" /></div></div></div></div>';

			$("#regionLocal_main").html(html);
		});

		//点击确定-区域围栏
		$(document).off("click","#regionLocal_btn").on("click","#regionLocal_btn",function(){
			if(triangle_lngLat.length < 3){
				toastr.error("边界点至少选择三个点");
				return;
			}
			
			//区域围栏-凸多边形校验
			if(!judge_convex_polygon(triangle_lngLat)){
				toastr.error('不是凸多边形,请按顺时针或逆时针绘制');//提示框
				return;
			}

			ctrl.regionLocal_fenceName();//开启区域围栏-名称
		});

		//点击确定-区域围栏-名字
		$(document).off("click","#fenceName_btn").on("click","#fenceName_btn",function(){
			var name = $("#fenceName_name").val();
			if(!name){
				toastr.error("请输入区域围栏名称");
				return;
			}

			var extra = {
				zoom:map.getZoom(),//缩放视图比例
				center:map.getCenter(),//中心点
			};

			triangle_lngLat[0] = [triangle_lngLat[0].lng,triangle_lngLat[0].lat];//多边形围栏过滤第一个数组

			var remarks = $("#fenceName_remarks").val();
			var postData = {
				type:2,
				user_id:info_login.data.id,//用户ID
				username:info_login.data.username,//用户名
				name:name,//围栏名
				remark:remarks,//围栏名
				points:JSON.stringify(triangle_lngLat),//点数组
				extra:JSON.stringify(extra),//其他参数
			};

			//ajax-添加区域围栏
			if(ajax_add_user_electric_fence(postData)){
				fn_draw_regionLocal();//重置区域围栏绘制
				ctrl.closeFence();//关闭电子围栏
			};
		});

		//点击关闭/取消-区域围栏-名称
		$(document).off("click","#fenceName_close,#fenceName_cancel").on("click","#fenceName_close,#fenceName_cancel",function(){
			ctrl.regionLocal_map();//开启区域围栏-地图选点
			fn_reset_fence();//重置围栏
			fn_draw_regionLocal();//重置区域围栏
		});

		//点击打开电子围栏报表
		$(document).off("click","#checkFence").on("click","#checkFence",function(){
			ajax_nav("fence-form");//路由导航
		});
    });

	//数组去空-区域围栏
	Array.prototype.noRepeat_fence = function(){
		var array = this;

		//去掉第一个
		if(array.length === 2){
			if(array[0].lng === array[1][0] && array[0].lat === array[1][1]){
				array.splice(1,1);
			}
		}

		//格式化-string
		function fn_format_str(arr){
			var key = [];
			arr.forEach(function(el,index){
				if(index==0){
					key[0]=arr[index];
				}else{
					key.push(JSON.stringify(arr[index]));
				}
			});	
			return key;
		}

		//格式化-parse
		function fn_format_parse(arr){
			var key = [];
			arr.forEach(function(el,index){
				if(index==0){
					key[0]=arr[index];
				}else{
					key.push(JSON.parse(arr[index]));
				}
			});	
			return key;
		}

		//去重
		function fn_noRepeat(arr){
			var key = [];
			for(var i=0;i<arr.length;i++){
				if(key.indexOf(arr[i])==-1){
			      key.push(arr[i])
			    }
			}
			return key;
		}
		
		var key1 = fn_format_str(array);//格式化-string
		var key2 = fn_noRepeat(key1);//去重
		var key3 = fn_format_parse(key2);//格式化-parse

		return key3;
	}

	fn_size_window();//窗体大小
</script>